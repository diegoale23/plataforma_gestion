{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="container mt-5">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-primary text-white">
        <h2 class="text-center">Análisis del Mercado Laboral</h2>
      </div>
      <div class="card-body">
        <!-- Resumen de Ofertas -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card text-center shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-primary">Total de Ofertas</h5>
                <p class="card-text fs-4">{{ total_offers }}</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-success">Ofertas Activas</h5>
                <p class="card-text fs-4">{{ active_offers }}</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title text-warning">Última Actualización</h5>
                <p class="card-text fs-5">{{ last_scraped|date:"d/m/Y"|default:"Nunca" }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráfico de Habilidades Demandadas -->
        <div class="mb-4">
          <h3 class="text-center">Habilidades Más Demandadas</h3>
          <canvas id="skillsChart" height="100"></canvas>
        </div>

        <!-- Habilidades por Región -->
        <div class="mb-4">
          <h3 class="text-center">Habilidades por Región</h3>
          <canvas id="regionSkillsChart" height="100"></canvas>
        </div>

        <!-- Habilidades por Fuente -->
        <div class="mb-4">
          <h3 class="text-center">Comparación por Fuente</h3>
          <canvas id="sourceSkillsChart" height="100"></canvas>
        </div>

        <!-- Inscritos por Habilidad -->
        {% if applicants_by_skill %}
          <div class="mb-4">
            <h3 class="text-center">Inscritos por Habilidad</h3>
            <canvas id="applicantsChart" height="100"></canvas>
          </div>
        {% endif %}

        <!-- Tendencias de Habilidades -->
        {% if skill_trends %}
          <div class="mb-4">
            <h3 class="text-center">Tendencias de Habilidades (Próximo Mes)</h3>
            <div class="table-responsive">
              <table class="table table-hover table-striped align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>Habilidad</th>
                    <th>Ocurrencias Totales</th>
                    <th>Puntuación Predicha</th>
                  </tr>
                </thead>
                <tbody>
                  {% for skill, data in skill_trends.items %}
                    <tr>
                      <td>{{ skill }}</td>
                      <td>{{ data.total_occurrences|default:"N/A" }}</td>
                      <td>{{ data.predicted_score|floatformat:2 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}

        <!-- Botones -->
        <div class="d-flex justify-content-center gap-3">
          <a href="?refresh=true" class="btn btn-primary btn-lg">Actualizar Datos</a>
          <a href="{% url 'export_skills_report' %}" class="btn btn-secondary btn-lg">Exportar Reporte</a>
          <a href="{% url 'job_offer_list' %}" class="btn btn-success btn-lg">Ver Todas las Ofertas</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scripts para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Gráfico de Habilidades Generales
      const skillsCtx = document.getElementById('skillsChart').getContext('2d');
      new Chart(skillsCtx, {
        type: 'bar',
        data: {
          labels: [{% for skill in top_skills %}'{{ skill.name|escapejs }}',{% endfor %}],
          datasets: [{
            label: 'Habilidades Demandadas',
            data: [{% for skill in top_skills %}{{ skill.num_offers }},{% endfor %}],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Número de Ofertas' } },
            x: { title: { display: true, text: 'Habilidades' } }
          }
        }
      });

      // Gráfico de Habilidades por Región
      const regionCtx = document.getElementById('regionSkillsChart').getContext('2d');
      new Chart(regionCtx, {
        type: 'bar',
        data: {
          labels: [{% for region in skills_by_region %}'{{ region.location|default:"Sin región"|escapejs }}',{% endfor %}],
          datasets: [
            {% for region in skills_by_region %}
              {
                label: '{{ region.location|default:"Sin región"|escapejs }}',
                data: [{% for skill in region.skills %}{{ skill.count }},{% endfor %}],
                backgroundColor: 'rgba({{ forloop.counter0|add:50 }}, 192, 192, 0.2)',
                borderColor: 'rgba({{ forloop.counter0|add:50 }}, 192, 192, 1)',
                borderWidth: 1
              },
            {% endfor %}
          ]
        },
        options: {
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Número de Ofertas' } },
            x: { title: { display: true, text: 'Habilidades' } }
          }
        }
      });

      // Gráfico de Habilidades por Fuente
      const sourceCtx = document.getElementById('sourceSkillsChart').getContext('2d');
      new Chart(sourceCtx, {
        type: 'bar',
        data: {
          labels: [{% for source in skills_by_source %}'{{ source.source__name|default:"Sin fuente"|escapejs }}',{% endfor %}],
          datasets: [
            {% for source in skills_by_source %}
              {
                label: '{{ source.source__name|default:"Sin fuente"|escapejs }}',
                data: [{% for skill in source.skills %}{{ skill.count }},{% endfor %}],
                backgroundColor: 'rgba({{ forloop.counter0|add:100 }}, 192, 192, 0.2)',
                borderColor: 'rgba({{ forloop.counter0|add:100 }}, 192, 192, 1)',
                borderWidth: 1
              },
            {% endfor %}
          ]
        },
        options: {
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Número de Ofertas' } },
            x: { title: { display: true, text: 'Habilidades' } }
          }
        }
      });

      // Gráfico de Inscritos por Habilidad
      {% if applicants_by_skill %}
        const applicantsCtx = document.getElementById('applicantsChart').getContext('2d');
        new Chart(applicantsCtx, {
          type: 'bar',
          data: {
            labels: [{% for skill in applicants_by_skill %}'{{ skill.name|escapejs }}',{% endfor %}],
            datasets: [{
              label: 'Inscritos Promedio',
              data: [{% for skill in applicants_by_skill %}{{ skill.avg_applicants|floatformat:1 }},{% endfor %}],
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Inscritos Promedio' } },
              x: { title: { display: true, text: 'Habilidades' } }
            }
          }
        });
      {% endif %}
    });
  </script>
{% endblock %}