<!-- market_analysis/templates/market_analysis/dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="container mt-5">
    <div class="card">
      <div class="card-header">
        <h2>Análisis del Mercado Laboral</h2>
      </div>
      <div class="card-body">
        <!-- Resumen de Ofertas -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">Total de Ofertas</h5>
                <p class="card-text">{{ total_offers }}</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">Ofertas Activas</h5>
                <p class="card-text">{{ active_offers }}</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">Última Actualización</h5>
                <p class="card-text">{{ last_scraped|date:"d/m/Y"|default:"Nunca" }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráfico de Habilidades Demandadas -->
        <div class="mb-4">
          <h3>Habilidades Más Demandadas</h3>
          <canvas id="skillsChart" height="100"></canvas>
        </div>

        <!-- Tendencias de Habilidades -->
        {% if skill_trends %}
          <div class="mb-4">
            <h3>Tendencias de Habilidades (Próximo Mes)</h3>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Habilidad</th>
                  <th>Ocurrencias Totales</th>
                  <th>Puntuación Predicha</th>
                </tr>
              </thead>
              <tbody>
                {% for skill, data in skill_trends.items %}
                  <tr>
                    <td>{{ skill }}</td>
                    <td>{{ data.total_occurrences|default:"N/A" }}</td>
                    <td>{{ data.predicted_score|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        <!-- Botones -->
        <a href="?refresh=true" class="btn btn-primary mb-3">Actualizar Datos</a>
        {% if request.resolver_match.url_name == 'market_dashboard' %}
          <a href="{% url 'job_offer_list' %}" class="btn btn-primary">Ver Todas las Ofertas</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Scripts para el gráfico -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const ctx = document.getElementById('skillsChart').getContext('2d');
      const skillsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [{% for skill in top_skills %}'{{ skill.name|escapejs }}',{% endfor %}],
          datasets: [{
            label: 'Habilidades Demandadas',
            data: [{% for skill in top_skills %}{{ skill.num_offers }},{% endfor %}],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Número de Ofertas'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Habilidades'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });
    });
  </script>
{% endblock %}